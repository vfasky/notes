/**
 * router
 * @module cepin/router
 * @author kotenei <kotenei@qq.com>
 */
define('note/router', ['jquery'], function($) {
    "use strict";

    /**
     * 事件处理
     * @type {Object}
     */
    var eventHelper = {
        addEventListener: function(element, type, handle) {
            if (element.addEventListener) {
                element.addEventListener(type, handle, false);
            } else if (element.attachEvent) {
                element.attachEvent("on" + type, handle);
            } else {
                element["on" + type] = handle;
            }
        },
        removeEventListener: function(element, type, handle) {
            if (element.removeEventListener) {
                element.removeEventListener(type, handle, false);
            } else if (element.detachEvent) {
                element.detachEvent("on" + type, handle);
            } else {
                element["on" + type] = null;
            }
        },
        proxy: function(fn, thisObject) {
            var proxy = function() {
                return fn.apply(thisObject || this, arguments);
            };
            return proxy;
        }
    };

    /**
     * 路由
     */
    var Router = function() {
        this._routes = [];
    };

    /**
     * 初始化
     * @return {Void}
     */
    Router.prototype.init = function() {
        var self = this;
        eventHelper.addEventListener(window, 'hashchange', eventHelper.proxy(self.listener, this));
        this.listener();
    };


    /**
     * 监听hash变化
     * @return {Void}
     */
    Router.prototype.listener = function() {
        var paths = location.hash.slice(1).split('?');
        var path = paths[0],
            params;

        if (paths[1]) {
            params = this.getUrlParams(paths[1]);
        }

        var route = this.getRoute(path);
        var values, ret = {};

        if (!route) {
            location.replace('#/');
            return;
        }

        values = this.getValues(path, route);

        for (var i = 0; i < route.params.length; i++) {
            ret[route.params[i]] = values[i];
        }

        params = $.extend({}, ret, params);
        route.handle(params);
    };

    /**
     * 取URL参数  param1=value1&param2=value2
     * @param  {String} str  - 带参数的字符串
     */
    Router.prototype.getUrlParams = function(str) {
        var params = {};
        if (!str) {
            return params;
        }
        var arrStr = str.split('&');
        for (var i = 0, arrParams; i < arrStr.length; i++) {
            arrParams = arrStr[i].split('=');
            params[arrParams[0]] = arrParams[1];
        }
        return params;
    };

    /**
     * 设置路由
     * @param  {String} routeUrl  - 路由地址
     * @param  {Object} constraints - 正则约束
     * @return {Object}
     */
    Router.prototype.map = function(routeUrl, constraints, callback) {
        var reg, pattern, result, params = [];
        pattern = routeUrl.replace(/\//g, '\\/');

        if (typeof constraints === 'function') {
            callback = constraints;
            constraints = null;
        }

        if (constraints) {
            for (var k in constraints) {
                reg = new RegExp('\\{' + k + '\\}', 'g');
                pattern = pattern.replace(reg, '(' + constraints[k].replace(/\^/, '').replace(/\$/, '') + ')');
                params.push(k);
            }
        }

        //(?<={)[^}]+(?=}) js不支持零宽断言-_-b
        reg = new RegExp('{([^}]+)}', 'g');
        //result;
        while ((result = reg.exec(pattern)) !== null) {
            params.push(result[1]);
            reg.lastIndex;
        }

        pattern = '^' + pattern.replace(/{[^}]+}/gi, '(.+)') + '$';

        this._routes.push({
            routeUrl: routeUrl,
            pattern: pattern,
            params: params,
            handle: callback || function() {}
        });

        return this;
    };

    /**
     * 获取参数值
     * @param  {String} path  - 路径
     * @param  {Object} route - 路由相关信息
     * @return {Array}
     */
    Router.prototype.getValues = function(path, route) {
        var route, values = [];

        if (path.length === 0) {
            return values;
        }

        route = route || this.getRoute(path);

        if (route !== null) {
            var matches = path.match(route.pattern);
            if (matches.length !== 0) {
                for (var i = 1; i < matches.length; i++) {
                    values.push(matches[i]);
                }
            }
        }
        return values;
    };

    /**
     * 获取匹配路由
     * @param  {String} path - 路径
     * @return {Object}
     */
    Router.prototype.getRoute = function(path) {
        for (var i = 0; i < this._routes.length; i++) {
            if (new RegExp(this._routes[i].pattern).test(path)) {
                return this._routes[i];
            }
        }
        return null;
    };

    return Router;
});
